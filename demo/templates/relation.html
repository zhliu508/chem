{% extends "base.html" %}
{% block mainbody %}
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>关系查询</title>
<meta charset="utf-8" />
<script src="/static/js/echarts.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css">
<style>
    /* 调整整体间距与右侧滚动 */
    .panel-body {
        padding: 15px;
    }
    .form-control {
        margin-bottom: 10px;
    }
    .query-panel {
        max-height: 650px;
        overflow-y: auto;
    }
    #graph {
        width: 100%;
        height: 700px;
    }
</style>
</head>

<div class="container-fluid">
    <div class="row">
        <!-- 页头 -->
        <div class="col-md-12">
            <h3 class="page-header"><i class="fa fa-link" aria-hidden="true"></i> 关系查询 </h3>
            <ol class="breadcrumb">
                <li><i class="fa fa-home"></i><a href="\">Home</a></li>
                <li><i class="fa fa-link" aria-hidden="true"></i>关系查询</li>
            </ol>
        </div>
    </div>

    <!-- 主体布局：左侧图表 + 右侧查询表单 -->
    <div class="row">

        <!-- 左侧关系图展示 -->
        <div class="col-md-10">
            {% if searchResult %}
            <div class="panel panel-default">
                <header class="panel-heading">关系图 :</header>
                <div class="panel-body">
                    <div id="graph"></div>
                </div>
            </div>
            {% else %}
            <div class="panel panel-default">
                <header class="panel-heading">关系图 :</header>
                <div class="panel-body">
                    <h4 class="text-center text-muted">暂无数据，请先在右侧输入条件查询</h4>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- 右侧查询条件 -->
        <div class="col-md-2">
            <div class="panel panel-default query-panel">
                <header class="panel-heading">查询条件：</header>
                <div class="panel-body">
                    <form id="searchRelationForm" method="get" class="form-vertical">

                        <input type="text" id="entity1_text" name="entity1_text"
                            class="form-control" placeholder="催化剂">





                        <button type="button" id="btnSearch" class="btn btn-primary btn-block"
                            onclick="document.getElementById('searchRelationForm').submit();">
                            搜索关系
                        </button>

                        <hr>

                        <input type="text" id="reactant_text" name="reactant_text"
                            class="form-control" placeholder="输入反应物名称">

                        <button type="button" class="btn btn-warning btn-block"
                            onclick="window.location.href='/search_full_reaction_path?reactant_text=' + encodeURIComponent($('#reactant_text').val());">
                            查询完整反应路径
                        </button>

                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 关系列表部分 -->
    {% if searchResult %}
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-default">
                <header class="panel-heading">关系列表 :</header>
                <div class="panel-body">
                    <table class="table" data-paging="true" data-sorting="true"></table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- JS 部分 -->
<script src="/static/js/jquery-1.8.3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js"></script>

{% if searchResult %}
<script type="text/javascript">
var searchResult = {{searchResult|safe}}
tableData = []
for (var i = 0; i < searchResult.length; i++) {
    relationData = {};
    relationData['entity1'] = searchResult[i]['n1']['title'];
    relationData['relation'] = searchResult[i]['rel']['type'];
    relationData['entity2'] = searchResult[i]['n2']['title'];
    tableData.push(relationData);
}

jQuery(function(){
    $('.table').footable({
        "columns": [
            {"name": "entity1", title: "Entity1"},
            {"name": "relation", title: "Relation"},
            {"name": "entity2", title: "Entity2"}
        ],
        "rows": tableData
    });
});

// ECharts 构图逻辑
var data = [];
var links = [];
var maxDisPlayNode = searchResult.length;
var id = 0;

for (var i = 0; id < maxDisPlayNode && i < searchResult.length; i++) {
    function makeNode(nodeData) {
        let node = {};
        node['name'] = nodeData['title'];
        node['draggable'] = true;

        if (/\[\d+\]R\d+/i.test(node['name'])) node['category'] = 4;
        else if (nodeData['labels'] && nodeData['labels'].includes('ZweliteData')) node['category'] = 3;
        else if ('url' in nodeData) node['category'] = 1;
        else node['category'] = 2;

        let flag = 1, relationTarget = id.toString();
        for (var j = 0; j < data.length; j++) {
            if (data[j]['name'] === node['name']) {
                flag = 0;
                relationTarget = data[j]['id'];
                break;
            }
        }
        node['id'] = relationTarget;
        if (flag === 1) {
            id++;
            data.push(node);
        }
        return node['id'];
    }

    let n1id = makeNode(searchResult[i]['n1']);
    let n2id = makeNode(searchResult[i]['n2']);

    let relation = {
        source: n1id,
        target: n2id,
        category: 0,
        value: searchResult[i]['rel']['type'],
        symbolSize: 10
    };

    links.push(relation);
}

var myChart = echarts.init(document.getElementById('graph'));
option = {
    tooltip: {},
    animationDurationUpdate: 1500,
    animationEasingUpdate: 'quinticInOut',
    series: [{
        type: 'graph',
        layout: 'force',
        symbolSize: 45,
        roam: true,
        edgeSymbol: ['none', 'arrow'],
        categories: [
            {name: '查询实体', itemStyle:{normal:{color:"#009800"}}},
            {name: 'HudongItem', itemStyle:{normal:{color:"#4592FF"}}},
            {name: 'NewNode', itemStyle:{normal:{color:"#C71585"}}},
            {name: 'ZweliteData', itemStyle:{normal:{color:"#FFD700"}}},
            {name: '[x]R类型节点', itemStyle:{normal:{color:"#0000FF"}}}
        ],
        label: {
            normal: {
                show: true,               // ✅ 直接显示节点名称
                position: 'inside',        // 可改为 'inside'、'top'
                textStyle: {
                    color: '#000',
                    fontSize: 12
                },
                formatter: '{b}'          // ✅ 节点名
            }
        },
        force: { repulsion: 1000 },
        edgeSymbolSize: [4, 50],
        edgeLabel: {
            normal: {
                show: true,
                textStyle: { fontSize: 10 },
                formatter: function (params) {
                    return params.data.value ? params.data.value : '';
                }
            }
        },
        data: data,
        links: links,
        lineStyle: {
            normal: {
                opacity: 0.9,
                width: 1.3,
                curveness: 0,
                color: "#262626"
            }
        }
    }]
};
myChart.setOption(option);
</script>
{% endif %}

<script>
$(".dropdown-menu li a").click(function(){
    var selText = $(this).text();
    $(this).parents('.btn-group').find('.dropdown-toggle')
        .html(selText + ' <span class="caret"></span>');
    if (selText.trim() != "Other") {
        $("#relation_name_input").val(selText.trim());
        $("#relation_name").addClass("hide");
    } else {
        $("#relation_name").removeClass("hide");
    }
});
</script>
{% endblock %}
